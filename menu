#!/bin/bash
export DOMAIN=$(cat /root/domain)
export VMESS_USER_FILE="/usr/local/etc/xray/users/vmess_users.json"
export VLESS_USER_FILE="/usr/local/etc/xray/users/vless_users.json"
export XRAY_CONFIG="/usr/local/etc/xray/config.json"

# --- FUNGSI UTILITAS ---
function reload_services() {
    systemctl reload xray > /dev/null 2>&1
}

function get_uuid() {
    cat /proc/sys/kernel/random/uuid
}

# --- FUNGSI TAMPILAN ---
function system_info() {
    local ram_usage=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    local disk_usage=$(df -h / | awk 'NR==2 {print $3 "/" $2}')
    
    clear
    echo -e "\e[1;35m╔══════════════[ \e[1;36mSYSTEM INFORMATION\e[1;35m ]══════════════╗\e[0m"
    echo -e "║ \e[1;32mOS\e[0m             : \e[1;37m$(lsb_release -ds)\e[1;35m"
    echo -e "║ \e[1;32mUptime\e[0m         : \e[1;37m$(uptime -p)\e[1;35m"
    echo -e "║ \e[1;32mDomain\e[0m         : \e[1;32m$DOMAIN\e[0m"
    echo -e "║ \e[1;32mRAM\e[0m            : \e[1;37m$ram_usage\e[1;35m"
    echo -e "║ \e[1;32mDisk\e[0m           : \e[1;37m$disk_usage\e[1;35m"
    echo -e "\e[1;35m╚══════════════════════════════════════════════════╝\e[0m"
}

# --- FUNGSI MANAJEMEN PENGGUNA ---
function create_user() {
    clear
    echo -e "\e[1;36m=================================\e[0m"
    echo -e " \e[1;37m      BUAT PENGGUNA BARU       \e[0m"
    echo -e "\e[1;36m=================================\e[0m"
    
    echo "Pilih Protokol: 1. SSH | 2. VMess (WS) | 3. VLESS (WS)"
    read -p "Pilihan [1-3]: " protocol_choice

    read -p "Username: " user
    if [[ -z "$user" ]]; then
        echo -e "\n\e[1;31m❌ Username tidak boleh kosong.\e[0m"; sleep 2; return
    fi
    read -p "Masa Aktif (hari): " exp
    exp_date=$(date -d "$exp days" +"%Y-%m-%d" 2>/dev/null)
    if [[ -z "$exp_date" ]]; then
        echo -e "\n\e[1;31m❌ Format masa aktif tidak valid.\e[0m"; sleep 2; return
    fi

    case $protocol_choice in
        1) # SSH
            echo -e "\n\e[1;33mMembuat user SSH untuk '$user'...\e[0m"
          sudo useradd -m -s /bin/bash "$user"
             sudo passwd "$user"
            # Mengatur tanggal kadaluwarsa & menonaktifkan shell setelah user dibuat
            usermod -e "$exp_date" -s /bin/bash "$user"
            clear
            echo -e "\n\e[1;32m✅ User SSH [$user] Dibuat dengan Aman!\e[0m"
            echo -e "   Host: $DOMAIN"
            echo -e "   Port 443 (SSL) & Port 80 (WS)"
            echo -e "   Expired on: $exp_date"
            ;;
        2) # VMess WS Port 80
            uuid=$(get_uuid)
            jq --arg user "$user" --arg uuid "$uuid" --arg exp "$exp_date" \
                '. += [{"user": $user, "uuid": $uuid, "exp": $exp}]' "$VMESS_USER_FILE" > tmp.json && mv tmp.json "$VMESS_USER_FILE"
            jq ".inbounds[0].settings.clients += [{\"id\": \"$uuid\", \"alterId\": 0}]" "$XRAY_CONFIG" > tmp.json && mv tmp.json "$XRAY_CONFIG"
            reload_services
            
            vmess_json="{\"v\":\"2\",\"ps\":\"${user}_VMESS_WS_80\",\"add\":\"$DOMAIN\",\"port\":\"80\",\"id\":\"$uuid\",\"aid\":\"0\",\"net\":\"ws\",\"type\":\"none\",\"host\":\"$DOMAIN\",\"path\":\"/vmess\",\"tls\":\"none\"}"
            vmess_link="vmess://$(echo "$vmess_json" | base64 -w 0)"
            
            clear
            echo -e "\n\e[1;32m✅ User VMess (WS) [$user] Dibuat!\e[0m"
            echo -e "   Port: 80 (WebSocket tanpa SSL)"
            echo -e "   Path: /vmess"
            echo -e "   Expired on: $exp_date\n"
            echo -e "\e[1;36m--- Link Konfigurasi ---\e[0m\n$vmess_link"
            ;;
        3) # VLESS WS Port 80
            uuid=$(get_uuid)
            jq --arg user "$user" --arg uuid "$uuid" --arg exp "$exp_date" \
                '. += [{"user": $user, "uuid": $uuid, "exp": $exp}]' "$VLESS_USER_FILE" > tmp.json && mv tmp.json "$VLESS_USER_FILE"
            jq ".inbounds[1].settings.clients += [{\"id\": \"$uuid\"}]" "$XRAY_CONFIG" > tmp.json && mv tmp.json "$XRAY_CONFIG"
            reload_services
            
            vless_link="vless://${uuid}@${DOMAIN}:80?encryption=none&headerType=none&type=ws&path=%2Fvless&host=${DOMAIN}#${user}_VLESS_WS_80"

            clear
            echo -e "\n\e[1;32m✅ User VLESS [$user] Dibuat!\e[0m"
            echo -e "   Port: 80 (WebSocket tanpa SSL)"
            echo -e "   Path: /vless"
            echo -e "   Expired on: $exp_date\n"
            echo -e "\e[1;36m--- Link Konfigurasi ---\e[0m\n$vless_link"
            ;;
        *)
            echo "Pilihan tidak valid."
            ;;
    esac
    read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
}


function list_users() {
    clear
    echo -e "\e[1;36m=================================\e[0m\n \e[1;37m       DAFTAR PENGGUNA         \e[0m\n\e[1;36m=================================\e[0m\n"
    echo -e "\e[1;33m--- User SSH ---\e[0m"
    printf "%-20s | %s\n" "Username" "Kadaluwarsa"
    printf "%-20s | %s\n" "--------------------" "------------------"
    while IFS=: read -r user _ uid _ _ _ _; do
        if [[ "$uid" -ge 1000 && "$user" != "nobody" ]]; then
            exp=$(chage -l "$user" | grep "Account expires" | awk -F": " '{print $2}')
            printf "\e[1;37m%-20s\e[0m | \e[1;32m%s\e[0m\n" "$user" "$exp"
        fi
    done < /etc/passwd

    echo -e "\n\e[1;33m--- User VMess (WebSocket) ---\e[0m"
    if jq -e '. | length == 0' "$VMESS_USER_FILE" >/dev/null; then
        echo "Tidak ada user VMess."
    else
        jq -r '.[] | "• \u001b[1;37m\(.user)\u001b[0m (Exp: \u001b[1;32m\(.exp)\u001b[0m)"' "$VMESS_USER_FILE"
    fi

    echo -e "\n\e[1;33m--- User VLESS (WebSocket) ---\e[0m"
    if jq -e '. | length == 0' "$VLESS_USER_FILE" >/dev/null; then
        echo "Tidak ada user VLESS."
    else
        jq -r '.[] | "• \u001b[1;37m\(.user)\u001b[0m (Exp: \u001b[1;32m\(.exp)\u001b[0m)"' "$VLESS_USER_FILE"
    fi

    read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
}

function delete_user() {
    clear
    echo -e "\e[1;36m=================================\e[0m\n \e[1;37m       HAPUS PENGGUNA          \e[0m\n\e[1;36m=================================\e[0m\n"
    read -p "Masukkan Username yang akan dihapus: " user_to_del
    if [[ -z "$user_to_del" ]]; then
        echo -e "\n\e[1;31m❌ Username tidak boleh kosong.\e[0m"; sleep 2; return
    fi
    user_found=false
    if id "$user_to_del" &>/dev/null; then
        userdel -r "$user_to_del"
        echo -e "\e[1;32m✓ User SSH '$user_to_del' dihapus.\e[0m"
        user_found=true
    fi

    vmess_uuid=$(jq -r --arg user "$user_to_del" '.[] | select(.user == $user) | .uuid' "$VMESS_USER_FILE")
    if [[ -n "$vmess_uuid" ]]; then
        jq "map(select(.user != \"$user_to_del\"))" "$VMESS_USER_FILE" > tmp.json && mv tmp.json "$VMESS_USER_FILE"
        jq "(.inbounds[0].settings.clients) |= map(select(.id != \"$vmess_uuid\"))" "$XRAY_CONFIG" > tmp.json && mv tmp.json "$XRAY_CONFIG"
        echo -e "\e[1;32m✓ User VMess '$user_to_del' dihapus.\e[0m"
        user_found=true
    fi

    vless_uuid=$(jq -r --arg user "$user_to_del" '.[] | select(.user == $user) | .uuid' "$VLESS_USER_FILE")
    if [[ -n "$vless_uuid" ]]; then
        jq "map(select(.user != \"$user_to_del\"))" "$VLESS_USER_FILE" > tmp.json && mv tmp.json "$VLESS_USER_FILE"
        jq "(.inbounds[1].settings.clients) |= map(select(.id != \"$vless_uuid\"))" "$XRAY_CONFIG" > tmp.json && mv tmp.json "$XRAY_CONFIG"
        echo -e "\e[1;32m✓ User VLESS '$user_to_del' dihapus.\e[0m"
        user_found=true
    fi

    if [[ "$user_found" == true ]]; then
        reload_services
    else
        echo -e "\e[1;31mUser '$user_to_del' tidak ditemukan.\e[0m"
    fi

    read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
}


function main_menu() {
    while true; do
        system_info
        echo -e "\e[1;35m╔══════════════[ \e[1;36mMENU UTAMA\e[1;35m ]══════════════╗\e[0m"
        echo -e "║ \e[1;32m1.\e[0m \e[1;37mBuat Pengguna\e[0m                           ║"
        echo -e "║ \e[1;32m2.\e[0m \e[1;37mHapus Pengguna\e[0m                          ║"
        echo -e "║ \e[1;32m3.\e[0m \e[1;37mDaftar Pengguna\e[0m                         ║"
        echo -e "║ \e[1;32m4.\e[0m \e[1;37mPerbarui Sertifikat SSL\e[0m                 ║"
        echo -e "║ \e[1;32m5.\e[0m \e[1;37mReboot Server\e[0m                           ║"
        echo -e "╟──────────────────────────────────────────╢"
        echo -e "║ \e[1;31m0.\e[0m \e[1;37mKeluar\e[0m                                    ║"
        echo -e "\e[1;35m╚══════════════════════════════════════════╝\e[0m"
        read -p "➡️  Pilih menu [0-5]: " pilih
        case $pilih in
            1) create_user ;;
            2) delete_user ;;
            3) list_users ;;
            4) 
                systemctl stop nginx; systemctl stop stunnel4
                certbot renew --force-renewal
                systemctl start nginx; systemctl start stunnel4
                read -n 1 -s -r -p "Selesai. Tekan tombol apa saja."
                ;;
            5) read -p "Anda yakin ingin reboot? (y/n): " confirm; if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then reboot; fi;;
            0) exit 0 ;;
            *) echo "Pilihan tidak valid." ; sleep 1 ;;
        esac
    done
}

main_menu