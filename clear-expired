#!/bin/bash
# Skrip untuk membersihkan pengguna yang sudah kedaluwarsa

# --- VARIABEL ---
TODAY=$(date +"%Y-%m-%d")
XRAY_CONFIG="/usr/local/etc/xray/config.json"
VMESS_USERS="/usr/local/etc/xray/users/vmess_users.json"
VLESS_USERS="/usr/local/etc/xray/users/vless_users.json"
LOG_FILE="/var/log/clear-expired.log"
NEEDS_RELOAD=false

echo "=================================================" >> $LOG_FILE
echo "Mulai pembersihan pada $(date)" >> $LOG_FILE

# --- FUNGSI ---
function delete_expired_xray_users() {
    local user_file=$1
    local user_type=$2
    local inbound_indices=($3)

    EXPIRED_UUIDS=$(jq -r --arg today "$TODAY" '.[] | select(.exp < $today) | .uuid' "$user_file")

    if [[ ! -z "$EXPIRED_UUIDS" ]]; then
        echo "Menghapus user $user_type kedaluwarsa..." >> $LOG_FILE
        NEEDS_RELOAD=true

        # Hapus dari config xray
        for uuid in $EXPIRED_UUIDS; do
            echo "  - Menghapus UUID: $uuid" >> $LOG_FILE
            for i in "${inbound_indices[@]}"; do
                jq "(.inbounds[$i].settings.clients) |= map(select(.id != \"$uuid\"))" "$XRAY_CONFIG" > tmp.json && mv tmp.json "$XRAY_CONFIG"
            done
        done

        # Update file data user
        jq --arg today "$TODAY" '[.[] | select(.exp >= $today)]' "$user_file" > tmp.json && mv tmp.json "$user_file"
    else
        echo "Tidak ada user $user_type yang kedaluwarsa." >> $LOG_FILE
    fi
}

function delete_expired_ssh_users() {
    echo "Memeriksa user SSH kedaluwarsa..." >> $LOG_FILE
    for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
        exp_date=$(chage -l "$user" | grep "Account expires" | awk -F": " '{print $2}')
        if [[ "$exp_date" != "never" && "$exp_date" < "$TODAY" ]]; then
            userdel -r "$user"
            echo "User SSH $user sudah expired dan dihapus." >> $LOG_FILE
        fi
    done
}

# --- JALANKAN ---
delete_expired_xray_users "$VMESS_USERS" "VMess" "0"
delete_expired_xray_users "$VLESS_USERS" "VLESS" "1 2"
delete_expired_ssh_users

if $NEEDS_RELOAD; then
    systemctl reload xray
fi

echo "Selesai pembersihan pada $(date)" >> $LOG_FILE